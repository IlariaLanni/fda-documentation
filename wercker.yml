# This references a standard debian container from the
# Docker Hub https://registry.hub.docker.com/_/debian/
# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box:
  id: jekyll/jekyll:builder
# You can also use services such as databases. Read more on our dev center:
# http://devcenter.wercker.com/docs/services/index.html
# services:
    # - postgres
    # http://devcenter.wercker.com/docs/services/postgresql.html

    # - mongodb
    # http://devcenter.wercker.com/docs/services/mongodb.html

# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html
build:
    # Steps make up the actions in your pipeline
    # Read more about steps on our dev center:
    # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    - script:
        name: make build directory
        code: |
          mkdir -p build
          chmod -R 777 build
    - script:
        name: generate site
        code: |
          jekyll build --destination build
          htmlproof build --empty-alt-ignore
deploy:
  steps:
    - shellcheck:
        files: run.sh

    - script:
        name: set version
        code: |
            export S3CMD_VERSION="1.5.1.2"
            echo "Installing version $S3CMD_VERSION of s3cmd"
    - script:
        name: install pyinstaller
        code: |
            apk add --update
            python
            python-dev
            py-pip
            sudo pip install python-dateutil
            sudo pip install pyinstaller
    - script:
        name: download s3cmd
        code: |
            curl -L https://github.com/s3tools/s3cmd/archive/v$S3CMD_VERSION.tar.gz > /tmp/s3cmd.tar.gz
            mkdir /tmp/s3cmd/
            tar xzvf /tmp/s3cmd.tar.gz -C /tmp/s3cmd/
    - script:
        name: pyinstaller
        code: |
            cd /tmp/s3cmd
            pyinstaller -F --name=s3cmd /tmp/s3cmd/s3cmd-$S3CMD_VERSION/s3cmd
    - script:
        name: prepare output
        code: |
            mv /tmp/s3cmd/dist/s3cmd $WERCKER_ROOT/s3cmd
            rm -rf $WERCKER_ROOT/.git
            rm -f $WERCKER_ROOT/.gitignore
    - script:
        name: version
        code: $WERCKER_ROOT/s3cmd --version
    - s3sync:
        source_dir: build/
        delete-removed: true
        bucket-url:   http://s3-us-west-1.amazonaws.com/fda-documentation
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY 
          
